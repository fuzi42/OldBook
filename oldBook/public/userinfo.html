<!DOCTYPE html>
<html lang="zh-Hans">
<head>
    <meta charset="UTF-8">
    <script src="http://libs.baidu.com/jquery/1.9.0/jquery.js" type="text/javascript"></script>
    <script src="https://cdn.bootcss.com/popper.js/1.12.9/umd/popper.min.js" integrity="sha384-ApNbgh9B+Y1QKtv3Rn7W3mgPxhU9K/ScQsAP7hUibX39j7fakFPskvXusvfa0b4Q" crossorigin="anonymous"></script>
    <script src="https://cdn.bootcss.com/bootstrap/4.0.0/js/bootstrap.min.js" integrity="sha384-JZR6Spejh4U02d8jOt6vLEHfe/JQGiRRSQQxSfFWpi1MquVdAyjUar5+76PVCmYl" crossorigin="anonymous"></script>
    <link rel="stylesheet" href="https://cdn.bootcss.com/bootstrap/4.0.0/css/bootstrap.min.css" integrity="sha384-Gn5384xqQ1aoWXA+058RXPxPg6fy4IWvTNh0E263XmFcJlSAwiGgFAW/dAiS6JXm" crossorigin="anonymous">
    <link rel="stylesheet" href="./static/css/style.css" >
    <script src="../public/static/js/doT.js"></script>
</head>
<body style="background:white;">
<div class="header-wrap">


</div>
<div class="title" style="width: 1000px;height: 100px;margin: auto;border-bottom: 1px #a6a3a394 solid;font-family: cursive">
    <h1 style="color:#8c222c;line-height: 2.5;">书屋-个人中心</h1>
</div>
<div style="width: 1000px;height: 100%;margin: auto">
    <div style="width: 180px;height: 500px; float: left;margin-right: 20px;border: 1px #a6a3a394 solid;">
        
        <div style="float: left;text-align: center;margin-top: 40px;height: 40px;overflow: hidden;position: relative;left: 20px;"><img src="./static/images/user_ico.jpg" style="width: 20px;height: auto;"/></div>
        <h6 style="position: relative;top: 40px;left: 30px;font-weight: normal;font-size: 14px;">个人资料</h6>
        
        <div style="float: left;text-align: center;margin-top: 50px;height: 40px;overflow: hidden;position: relative;left: 0px;"><img src="./static/images/user_ico.jpg" style="width: 20px;height: auto;position: relative;top:-80px"/></div>
        <h6 style="position: relative;top: 50px;left: 10px;font-weight: normal;font-size: 14px;">我的订单</h6>
        <div style="float: left;text-align: center;margin-top: 60px;height: 40px;overflow: hidden;position: relative;left: -20px;"><img src="./static/images/user_ico.jpg" style="width: 20px;height: auto;position: relative;top:-120px"/></div>
        <h6 style="position: relative;top: 60px;left: -10px;font-weight: normal;font-size: 14px;">我的交易</h6>
        <div style="float: left;text-align: center;margin-top: 70px;height: 40px;overflow: hidden;position: relative;left: -40px;"><img src="./static/images/user_ico.jpg" style="width: 20px;height: auto;position: relative;top:-160px"/></div>
        <h6 style="position: relative;top: 70px;left: -30px;font-weight: normal;font-size: 14px;">我收藏的商品</h6>
        <hr style="margin-top: 100px;background: #80808069;"/>
    </div>
    <div style="margin-left: 30px;margin-top: 50px;">
        <div><img id="image" src="" alt=""  style="width: 100px;height: 100px;float: left"/>
        <h4 id='name' style="margin-left: 120px"></h4>
        </div>
        <div style="width: 100%;margin-top: 100px;"><h3 id="shop_name"></h3><button id="up" type="button"  class="btn btn-primary" data-toggle="modal" data-target=".bd-example-modal-lg">上架</button></div>
    <div id="myBook" style="width: 100%;margin:50px auto;">
       
    </div>
    </div>

</div>

<div class="modal fade bd-example-modal-lg" tabindex="-1" role="dialog" aria-labelledby="myLargeModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content" style="height: 800px;padding: 60px;">
            <h2 style="margin-bottom: 20px">上架发布</h2>
            <div class="input-group mb-3">
                <div class="input-group-prepend">
                    <button id="kind" class="btn btn-outline-secondary dropdown-toggle" type="button" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">种类</button>
                    <div class="dropdown-menu">
                        <a class="dropdown-item" href="#" onclick="test(this)">计算机IT</a>
                        <a class="dropdown-item" href="#" onclick="test(this)">文学</a>
                        <a class="dropdown-item" href="#" onclick="test(this)">数学</a>
                        <a class="dropdown-item" href="#" onclick="test(this)">生物</a>
                        <a class="dropdown-item" href="#" onclick="test(this)">物理</a>
                    </div>
                </div>
                <input id="title" type="text" class="form-control" aria-label="Text input with dropdown button" placeholder="标题">
            </div>
            <input id="message" type="text" class="form-control" aria-label="Text input" placeholder="描述">
            <div class="input-group mb-3" style="margin-top: 15px;">
                <div class="input-group-prepend">
                    <span class="input-group-text">$</span>
                </div>
                <input id="price" type="text" class="form-control" aria-label="Amount (to the nearest dollar)"
                       oninput="value=value.replace(/[^\d]/g,'')">
                <div class="input-group-append">
                    <span class="input-group-text">.00</span>
                </div>
            </div>
            <div style="margin-top: 30px;">
<!--                <textarea style=""></textarea>-->
                <div class="productDrawingBox">
                    <div class="productDescription">上传图片</div>
                    <div class="productImg">
                        <div id="uploadBox">
                        </div>
                        <div class="uploadDIv">
                            <span>+</span><input type="file" name="file" multiple id="inputs" accept="image/*" class='fileTest' multiple="multiple" />
                        </div>
                    </div>
                </div>

            </div>
            <div style="top: 100px;position: relative;margin: auto"><button style="width: 200px" onclick="upbook()">上架</button></div>

        </div>
    </div>
</div>
</body>
<script type="text/x-dot-template" id="demo0">
    {{~it:value:index}}
    <div style="float: left;margin:10px 20px">
        <img src="/public/booksImages/{{=value.images}}" alt="sd" style="width: 100px;height:120px"/>
        <h5 style="font-size:12px">{{=value.title}}</h5>
        <h5 style="font-size:12px">{{=value.messages}}</h5>
        <h5 style="font-size:12px">{{=value.price}}</h5>
    </div>
    {{~}}
</script>
<script>
    var booksImages=null;
    $(document).ready(function(){
        $.ajax({
            url: '/denglu',
            type: 'post',
            credentials:true,

            // data: { name: $('.name').val() ,password: $('.password').val()},

            dataType: 'json',
            success: function (res) {
                // 一旦设置的 dataType 选项，就不再关心 服务端 响应的 Content-Type 了
                // 客户端会主观认为服务端返回的就是 JSON 格式的字符串
                if(res['message']){
                    $('#name').text(res['name']);
                    $('#image').attr("src", res['userimage']);
                    $('#shop_name').text(res['name']+"的书摊");
                    var bookData=[];
                    for( var i in res["book_list"]){
                        var data={"images":res["book_list"][i]["images"],"title":res["book_list"][i]["title"],"messages":res["book_list"][i]["messages"],"price":res["book_list"][i]["price"]}
                        bookData[i]=data;
                    }
                    console.log(bookData)
                tmpltxt=doT.template(document.getElementById("demo0").innerHTML);//生成模板方法
                document.getElementById("myBook").innerHTML=tmpltxt(bookData);//数据渲染

                }
            }
        })
            $('#up').on('click', function() {
                $('#myModal').modal('show')
            });
        });
    $(function() {
        var img = []; //创建一个空对象用来保存传入的图片
        var AllowImgFileSize = '1013760'; //10兆
        $("#inputs").change(function() {
            var fil = this.files;
            for(var i = 0; i < fil.length; i++) {

                    reads(fil[i]);
                    img.push(fil[i].name); //将传入的图片push到空对象中
                console.log(fil[i])
            }
            if(img.length >= 6) { //判断图片的数量，数量不能超过3张
                $('.uploadDIv').hide();
            } else {
                $('.uploadDIv').show();
            }
            booksImages=img;
        });

        function reads(fil) {
            var reader = new FileReader();
            reader.readAsDataURL(fil);
            reader.onload = function() {
                document.getElementById("uploadBox").innerHTML += "<div class='divImg' id='uploadImg'><img src='" + reader.result + "' class='imgBiMG'></div>";
            }
            var formData = new FormData();
            formData.append('img', fil);
            $.ajax({
                url: '/sendBook',
                type: 'post',
                credentials:true,
                processData:false,
                contentType:false,
                data: formData,
                dataType: 'json',
                success: function (res) {
                    // 一旦设置的 dataType 选项，就不再关心 服务端 响应的 Content-Type 了
                    // 客户端会主观认为服务端返回的就是 JSON 格式的字符串
                    if(res['message']){


                    }
                }
            })
        }
    })
function test(item) {

    $('#kind').text(item.innerHTML)
}
function upbook() {
    var kind=$('#kind').text();
    var title=$('#title').val();
    var price=$('#price').val();
    var message=$('#message').val();
    console.log(kind,title,price);
    $.ajax({
        url: '/sendBook',
        type: 'post',
        headers:{"content-type":"application/json"},

        data: JSON.stringify({ kind:kind,title:title,price:price,images:booksImages,message:message}),

        dataType: 'json',
        success: function (res) {
            // 一旦设置的 dataType 选项，就不再关心 服务端 响应的 Content-Type 了
            // 客户端会主观认为服务端返回的就是 JSON 格式的字符串
            if(res['message']){

               alert('上架成功！');
               window.location.reload();
            }
        }
    })
}
  
</script>
</html>